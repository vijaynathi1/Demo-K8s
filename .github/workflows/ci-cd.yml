name: Demo-K8s CI/CD

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  EKS_CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME }}
  IMAGE_TAG: ${{ github.sha }}
  K8S_NAMESPACE: demo-k8s

jobs:
  ci:
    name: Build & Push to ECR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps & run tests
        working-directory: app
        run: |
          npm install
          npm test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image to ECR
        uses: docker/build-push-action@v6
        with:
          context: ./app
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

  cd:
    name: Deploy to EKS with Helm
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install kubectl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl apt-transport-https
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --name "${EKS_CLUSTER_NAME}" \
            --region "${AWS_REGION}"

      - name: Create namespace if not exists
        run: |
          kubectl get namespace "${K8S_NAMESPACE}" >/dev/null 2>&1 || \
          kubectl create namespace "${K8S_NAMESPACE}"

      - name: Helm Lint
        run: helm lint ./helm/demo-k8s || true

      - name: Helm Template (render preview)
        run: |
          helm template demo-k8s ./helm/demo-k8s \
            --namespace "${K8S_NAMESPACE}" \
            --set image.repository="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" \
            --set image.tag="${IMAGE_TAG}" \
            > rendered.yaml
          echo "=== Template Preview (first 200 lines) ==="
          head -n 200 rendered.yaml

      - name: Deploy with Helm (no wait, always debug after)
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
        run: |
          set -euo pipefail
          
          IMAGE_REPO="${REGISTRY}/${ECR_REPOSITORY}"
          RELEASE_NAME="demo-k8s"
          
          echo "Deploying release=${RELEASE_NAME}"
          echo "Image = ${IMAGE_REPO}:${IMAGE_TAG}"
          echo "Namespace = ${K8S_NAMESPACE}"

          # Install without waiting so we can capture logs
          helm upgrade --install "${RELEASE_NAME}" ./helm/demo-k8s \
            --namespace "${K8S_NAMESPACE}" \
            --create-namespace \
            --set image.repository="${IMAGE_REPO}" \
            --set image.tag="${IMAGE_TAG}"

          # Allow pods to start
          sleep 20

      - name: Debug â€” Show pods, events, logs
        run: |
          echo "=== PODS ==="
          kubectl get pods -n "${K8S_NAMESPACE}" -o wide || true

          echo "=== SERVICES ==="
          kubectl get svc -n "${K8S_NAMESPACE}" -o wide || true

          echo "=== EVENTS ==="
          kubectl get events -n "${K8S_NAMESPACE}" --sort-by=.metadata.creationTimestamp || true

          echo "=== DESCRIBE PODS ==="
          kubectl describe pods -n "${K8S_NAMESPACE}" || true

          echo "=== LOGS ==="
          for p in $(kubectl get pods -n "${K8S_NAMESPACE}" -o jsonpath='{.items[*].metadata.name}'); do
            echo "--- Logs for $p ---"
            kubectl logs $p -n "${K8S_NAMESPACE}" --all-containers=true --tail=200 || true
          done
